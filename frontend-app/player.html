<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player - Video Processing System</title>
    <!-- Include env.js first to set the API Base URL -->
    <script src="env.js"></script>
    <!-- Include config.js after env.js -->
    <script src="config.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Video Transcoder</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="config.html">Configuration</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="upload.html">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="jobs.html">Jobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="player.html">Player</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1>Video Player</h1>
                <p class="lead">View your transcoded videos</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Video Player</h5>
                    </div>
                    <div class="card-body">
                        <div class="video-container">
                            <video id="video-player" controls></video>
                        </div>
                        <div class="resolution-selector">
                            <label class="form-label">Resolution:</label>
                            <div class="btn-group" role="group" id="resolution-buttons">
                                <button type="button" class="btn btn-outline-primary"
                                    data-resolution="720p">720p</button>
                                <button type="button" class="btn btn-outline-primary"
                                    data-resolution="480p">480p</button>
                                <button type="button" class="btn btn-outline-primary"
                                    data-resolution="360p">360p</button>
                            </div>
                        </div>
                        <div class="alert alert-info" id="player-message">
                            Select a video from the list of completed jobs to play.
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Completed Videos</h5>
                    </div>
                    <div class="card-body">
                        <div id="completed-jobs-list">
                            <p class="text-center">Loading completed jobs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container text-center">
            <p>Video Transcoding System &copy; 2023</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/job-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const videoPlayer = document.getElementById('video-player');
            const resolutionButtons = document.getElementById('resolution-buttons').querySelectorAll('button');
            const playerMessage = document.getElementById('player-message');
            const completedJobsList = document.getElementById('completed-jobs-list');

            let currentVideoId = null;
            let currentVideoData = null;

            // Load completed jobs
            loadCompletedJobs();

            // Function to load completed jobs
            function loadCompletedJobs() {
                jobManager.fetchJobs()
                    .then(jobs => {
                        const completedJobs = jobs.filter(job => job.status === 'COMPLETED');

                        if (completedJobs.length === 0) {
                            completedJobsList.innerHTML = '<p class="text-center">No completed jobs found.</p>';
                            return;
                        }

                        // Display completed jobs
                        completedJobsList.innerHTML = '';
                        completedJobs.forEach(job => {
                            const videoName = job.videoKey.split('/').pop() || job.videoKey;
                            const jobItem = document.createElement('div');
                            jobItem.className = 'card mb-2';
                            jobItem.innerHTML = `
                                <div class="card-body">
                                    <h6 class="card-title">${videoName}</h6>
                                    <p class="card-text small text-muted">ID: ${job.jobId}</p>
                                    <button class="btn btn-sm btn-primary play-video" data-job-id="${job.jobId}">
                                        Play Video
                                    </button>
                                </div>
                            `;
                            completedJobsList.appendChild(jobItem);

                            // Add event listener to play button
                            jobItem.querySelector('.play-video').addEventListener('click', () => {
                                loadVideoPlayer(job.jobId);
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error loading completed jobs:', error);
                        completedJobsList.innerHTML = '<p class="text-center text-danger">Error loading jobs.</p>';
                    });
            }

            // Function to load video player with job ID
            function loadVideoPlayer(jobId) {
                playerMessage.innerHTML = 'Loading video data...';
                playerMessage.classList.remove('d-none');

                // Fetch job details to get streaming info
                fetch(`/api/jobs/${jobId}`)
                    .then(response => response.json())
                    .then(jobData => {
                        if (!jobData.streaming) {
                            playerMessage.innerHTML = 'This job does not have streaming information yet.';
                            return;
                        }

                        currentVideoData = jobData.streaming;
                        currentVideoId = jobData.streaming.videoId;

                        // Load the master playlist
                        loadVideo(jobData.streaming.masterPlaylist);

                        // Update resolution buttons
                        updateResolutionButtons(jobData.streaming.resolutions);

                        // Hide the message
                        playerMessage.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('Error loading job details:', error);
                        playerMessage.innerHTML = 'Error loading video data.';
                        playerMessage.classList.remove('d-none');
                    });
            }

            // Function to load video with URL
            function loadVideo(url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function () {
                        videoPlayer.play();
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // Native HLS support (Safari)
                    videoPlayer.src = url;
                    videoPlayer.addEventListener('loadedmetadata', function () {
                        videoPlayer.play();
                    });
                } else {
                    playerMessage.innerHTML = 'Your browser does not support HLS playback.';
                    playerMessage.classList.remove('d-none');
                }
            }

            // Function to update resolution buttons
            function updateResolutionButtons(resolutions) {
                if (!resolutions) return;

                // Enable all resolution buttons that are available
                resolutionButtons.forEach(button => {
                    const resolution = button.getAttribute('data-resolution');
                    if (resolutions[resolution]) {
                        button.disabled = false;
                        button.addEventListener('click', () => {
                            loadVideo(resolutions[resolution]);

                            // Update active button
                            resolutionButtons.forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                        });
                    } else {
                        button.disabled = true;
                    }
                });
            }

            // Add refresh button functionality
            document.querySelectorAll('.btn-refresh').forEach(button => {
                button.addEventListener('click', loadCompletedJobs);
            });
        });
    </script>
</body>

</html>