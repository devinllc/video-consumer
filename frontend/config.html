<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Video Processing System</title>
    <!-- Include env.js first to set the API Base URL -->
    <script src="env.js"></script>
    <!-- Include config.js after env.js -->
    <script src="config.js"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="app-title">
            <i class="fas fa-film"></i>
            <span>Video Processing System</span>
        </div>
    </header>

    <div class="container">
        <div class="card" id="config-section">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cog"></i>
                    System Configuration
                </h2>
            </div>

            <form id="config-form">
                <div class="config-section">
                    <h3>AWS Configuration</h3>
                    <div class="form-group">
                        <label for="aws-region">AWS Region</label>
                        <input type="text" id="aws-region" name="AWS_REGION" placeholder="e.g. ap-south-1">
                    </div>
                    <div class="form-group">
                        <label for="aws-access-key">AWS Access Key</label>
                        <input type="text" id="aws-access-key" name="AWS_ACCESS_KEY_ID"
                            placeholder="Enter AWS Access Key">
                    </div>
                    <div class="form-group">
                        <label for="aws-secret-key">AWS Secret Key</label>
                        <input type="password" id="aws-secret-key" name="AWS_SECRET_ACCESS_KEY"
                            placeholder="Enter AWS Secret Key">
                    </div>
                </div>

                <div class="config-section">
                    <h3>S3 Configuration</h3>
                    <div class="form-group">
                        <label for="s3-bucket">S3 Bucket Name</label>
                        <input type="text" id="s3-bucket" name="S3_BUCKET_NAME" placeholder="Enter S3 bucket name">
                    </div>
                    <div class="form-group">
                        <label for="s3-input-prefix">Input Prefix</label>
                        <input type="text" id="s3-input-prefix" name="S3_INPUT_PREFIX" placeholder="e.g. input/">
                    </div>
                    <div class="form-group">
                        <label for="s3-output-prefix">Output Prefix</label>
                        <input type="text" id="s3-output-prefix" name="S3_OUTPUT_PREFIX" placeholder="e.g. output/">
                    </div>
                </div>

                <div class="config-section">
                    <h3>ECS Configuration</h3>
                    <div class="form-group">
                        <label for="ecs-cluster">ECS Cluster</label>
                        <input type="text" id="ecs-cluster" name="ECS_CLUSTER" placeholder="Enter ECS cluster name">
                    </div>
                    <div class="form-group">
                        <label for="ecs-task-definition">Task Definition</label>
                        <input type="text" id="ecs-task-definition" name="ECS_TASK_DEFINITION"
                            placeholder="Enter task definition name">
                    </div>
                    <div class="form-group">
                        <label for="ecs-container-name">Container Name</label>
                        <input type="text" id="ecs-container-name" name="ECS_CONTAINER_NAME"
                            placeholder="Enter container name">
                    </div>
                    <div class="form-group">
                        <label for="ecs-subnet-id">Subnet ID</label>
                        <input type="text" id="ecs-subnet-id" name="ECS_SUBNET_ID" placeholder="Enter subnet ID">
                    </div>
                    <div class="form-group">
                        <label for="ecs-security-group">Security Group</label>
                        <input type="text" id="ecs-security-group" name="ECS_SECURITY_GROUP"
                            placeholder="Enter security group ID">
                    </div>
                </div>

                <div id="config-status" class="config-status"></div>

                <div class="form-actions">
                    <button type="submit" class="button" id="save-button">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                    <button type="button" class="button outline" id="test-connection-button">
                        <i class="fas fa-vial"></i>
                        Test Connection
                    </button>
                    <button type="button" class="button outline" id="test-s3-button">
                        <i class="fas fa-vial"></i>
                        Test S3
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get form and status elements
            const configForm = document.getElementById('config-form');
            const configStatus = document.getElementById('config-status');
            const testConnectionButton = document.getElementById('test-connection-button');
            const testS3Button = document.getElementById('test-s3-button');

            // Load existing configuration if available
            loadConfiguration();

            // Set up form submission
            configForm.addEventListener('submit', function (e) {
                e.preventDefault();
                saveConfiguration();
            });

            // Set up test buttons
            testConnectionButton.addEventListener('click', testConnection);
            testS3Button.addEventListener('click', testS3);

            // Load existing configuration
            function loadConfiguration() {
                fetch(getApiUrl(API_CONFIG.ENDPOINTS.CONFIG))
                    .then(response => response.json())
                    .then(data => {
                        console.log('Loaded configuration:', data);

                        // Populate form fields with the loaded configuration
                        for (const [key, value] of Object.entries(data)) {
                            const input = document.querySelector(`[name="${key}"]`);
                            if (input) {
                                input.value = value;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading configuration:', error);
                        configStatus.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Could not load existing configuration. You may need to set it up for the first time.
                            </div>
                        `;
                    });
            }

            // Save configuration
            function saveConfiguration() {
                // Collect all form inputs
                const formData = new FormData(configForm);
                const config = {};

                // Convert FormData to JSON object
                for (const [key, value] of formData.entries()) {
                    if (value.trim() !== '') {
                        config[key] = value.trim();
                    }
                }

                // Set loading status
                configStatus.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i>
                        Saving configuration...
                    </div>
                `;

                // Save configuration to server
                fetch(getApiUrl(API_CONFIG.ENDPOINTS.CONFIG), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            configStatus.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i>
                                    Configuration saved successfully!
                                </div>
                            `;
                        } else {
                            configStatus.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i>
                                    Failed to save configuration: ${data.error}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error saving configuration:', error);
                        configStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i>
                                Error: ${error.message}
                            </div>
                        `;
                    });
            }

            // Test AWS connection
            function testConnection() {
                configStatus.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i>
                        Testing AWS connection...
                    </div>
                `;

                fetch(getApiUrl(API_CONFIG.ENDPOINTS.TEST_CONNECTION))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            configStatus.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i>
                                    AWS connection successful!
                                </div>
                            `;
                        } else {
                            configStatus.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i>
                                    AWS connection failed: ${data.error}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error testing connection:', error);
                        configStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i>
                                Error: ${error.message}
                            </div>
                        `;
                    });
            }

            // Test S3 connection
            function testS3() {
                configStatus.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i>
                        Testing S3 bucket access...
                    </div>
                `;

                fetch(getApiUrl(API_CONFIG.ENDPOINTS.TEST_S3))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            configStatus.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i>
                                    S3 bucket access successful!
                                </div>
                            `;
                        } else {
                            configStatus.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i>
                                    S3 bucket access failed: ${data.error}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error testing S3:', error);
                        configStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i>
                                Error: ${error.message}
                            </div>
                        `;
                    });
            }
        });
    </script>
</body>

</html>